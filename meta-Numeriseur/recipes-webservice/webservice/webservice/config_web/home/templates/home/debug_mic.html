{% extends "home/base.html" %}
{% block title %}Debugging{% endblock %}
{% block content %}
{% load static %}

          
    <style>
    .center_div {
      width: 500px;
      height: 100px;
      background-color: #f5f5f5;
      border: 1px solid #808080;
      position: absolute;
      top: 50%;
      left: 50%;
      margin-left: -250px;
      /* half width*/
      margin-top: -50px;
      /* half height*/
      padding: 25px;
    }

    .recording_label {
      display: block;
      text-align: center;
      padding: 10px;
      font-family: sans-serif;
      font-size: 1.1em;
      margin-bottom: 25px;
    }

    .loader_bg {
      min-width: 100%;
      background: #c5c5c5;
      min-height: 20px;
      display: block;
    }

    .loader_bg1 {
      min-width: 90%;
      background: grey;
      min-height: 20px;
      display: inline-block;
      position: relative;
      top: -20px;
    }
  </style>
                <div class="x_panel">

                  <div class="x_title">
                    <div class="" role="tabpanel" data-example-id="togglable-tabs">
                        <ul id="myTab" class="nav nav-tabs bar_tabs" role="tablist">
                          <li role="presentation" class="active"><a href="#tab_content1" id="home-tab" role="tab" data-toggle="tab" aria-expanded="true">Enregistrement audio</a>
                          </li>
                        </ul>
                      </div>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content">


                <div id="myTabContent" class="tab-content">
                <div role="tabpanel" class="tab-pane active " id="tab_content1" aria-labelledby="home-tab">
              <div class="col-md-12 col-sm-12 ">
              <div class="x_panel">
                <div class="x_content">
                  <div id="alerts"></div>
                  <div class="btn-toolbar editor" data-role="editor-toolbar" data-target="#editor-one">
                  <fieldset>
                    
                           <div class="btn-group">
                            <div class="btn">
                            <button onclick="startRecording()" name=""  class="btn btn-secondary source">start recording</button>
                            
                            <div class="btn">
                           </div>
                           <div class="btn-group">
                            <div class="btn">
                              <audio controls style="display:none;" id="audio">
                                <source src="{% static 'upload/voice.wav' %}" type="audio/mpeg">
                              </audio>
                            </div>
                           </div>
                  </fieldset>
                  </div>
                  
                   <div class="center_div" style="display:none;" id="bar">
                              <span class="recording_label">Please wait...</span>
                              <span class="loader_bg"></span>
                              <span class="loader_bg1"></span>
                    </div>
                  
                  


                  
                </div>
              </div>
            </div>


                          </div>
                          
                         
                  
                  </div>
          
                      
                  </div>
                </div>
                

{% endblock %}

{% block javascript %}

<!-- Switchery -->
<script src="{% static '/vendors/switchery/dist/switchery.min.js' %}" type="text/javascript"></script>
<!-- Select2 -->

 <script>

   
    function startRecording() {

      

      $.ajax({
        type : "POST", 
        url:'{% url "audio_mic_record" %}',
        data: {command:"record_start" ,                           
        csrfmiddlewaretoken: '{{ csrf_token }}',
        dataType: "json",
        },
                                       
        success: function(data){
                    if (data.success) {
                        document.getElementById('bar').style.display = "block";
                        var max = 5;
                        var count = max + 1;
                        var counter = setInterval(timer, 1000);
                        function timer() {
                          count = count - 1;
                          if (count <= 0) {
                                clearInterval(counter);
                                $(".recording_label").html("Recording...");
                                $('.loader_bg1').css({
                                      'min-width': '' + (100) + '%'
                                    })
                                  recordingSec(20); 
                                  Recording();
                                      return;

                                  }
                                  $(".recording_label").html("Recording will begin in " + count + " sec.");
                                  var percent = (count / max) * 100;
                                  $('.loader_bg1').css({
                                    'min-width': '' + (100 - percent) + '%'
                                  })
                                };   
                    }else{

                      new PNotify({
                            text: "veuillez verifier que le microphone d'ambiance est bien installé",
                            type: 'info',
                            styling: 'bootstrap3'
                      });

                    }
                                              
                },


        failure: function(data) {
                  alert(data);

                   new PNotify({
                            text: "veuillez verifier que le microphone d'ambiance est bien installé",
                            type: 'info',
                            styling: 'bootstrap3'
                      });
                                           
                }


        });

    }

    function Recording() {
      
      $.ajax({
        type : "POST", 
        url: '{% url "mic_record" %}',
        data: {
                command:"recording",
                csrfmiddlewaretoken: '{{ csrf_token }}',
                dataType: "json",
              },
                                         
        success: function(data){


                  if (data.success) {
                  new PNotify({
                            text: "l'enregistrement est terminé",
                            type: 'info',
                            styling: 'bootstrap3'
                      });
                  document.getElementById('bar').style.display = "none";
                  document.getElementById('audio').style.display = "block";

                  if($("#recognition").is(":checked")){
                    document.getElementById('editor-one').style.display = "block";
                    $("#editor-one").text(data.data);


                  }

                }else{
                   new PNotify({
                            text: "l'enregistrement a echoué, veuillez réessayer",
                            type: 'error',
                            styling: 'bootstrap3'
                      });
                }

                  
                  

                },
        failure: function(data) {

                  new PNotify({
                            text: "l'enregistrement a echoué, veuillez réessayer",
                            type: 'error',
                            styling: 'bootstrap3'
                      });

                                           
                }


        });

    }


    function recordingSec(sec) {
        var count = sec + 1;
        var counter = setInterval(timer, 1000);

        function timer() {
                count = count - 1;
                if (count <= 0) {
                clearInterval(counter);
                $(".recording_label").html("Recording stopped");
                $('.loader_bg1').css({
                                'min-width': '' + (100) + '%'
                  })
                  return;
                  }
                $(".recording_label").html("Recording started [ " + (sec - count) + " / " + sec + " ] sec.");
                        var percent = (count / sec) * 100;
                        $('.loader_bg1').css({
                              'min-width': '' + (100 - percent) + '%'
                        })
                    }
   }

              
   
  </script>


{% endblock %}

